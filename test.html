<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Card Reader - CCCD / Zairyu</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #1a1a2e;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-bar.disconnected { background: #fee2e2; color: #991b1b; }
        .status-bar.disconnected .status-dot { background: #ef4444; }
        .status-bar.connected { background: #d1fae5; color: #065f46; }
        .status-bar.connected .status-dot { background: #10b981; }
        .status-bar.waiting { background: #fef3c7; color: #92400e; }
        .status-bar.waiting .status-dot { background: #f59e0b; animation: pulse 1s infinite; }
        .status-bar.reading { background: #dbeafe; color: #1e40af; }
        .status-bar.reading .status-dot { background: #3b82f6; animation: pulse 0.5s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Card Type Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab:hover { border-color: #3b82f6; }
        .tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .tab .icon { font-size: 24px; display: block; margin-bottom: 5px; }
        
        /* Form */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px 14px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        input::placeholder {
            color: #9ca3af;
        }
        .input-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* Buttons */
        button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            margin-top: 10px;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
            margin-top: 10px;
        }
        
        /* Scan Animation */
        .scan-area {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        .scan-area.active { display: block; }
        .nfc-icon {
            font-size: 80px;
            animation: float 2s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        /* Results */
        .result-area {
            display: none;
        }
        .result-area.show { display: block; }
        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .result-header h3 { color: #065f46; }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .result-label { color: #6b7280; font-size: 14px; }
        .result-value { 
            font-weight: 600; 
            color: #111827; 
            word-break: break-all;
            text-align: right;
            max-width: 60%;
        }
        
        /* Error */
        .error-msg {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-size: 14px;
            white-space: pre-line;
            line-height: 1.5;
        }
        .error-msg.show { display: block; }
        
        /* Log */
        .log-card {
            background: #1f2937;
            border-radius: 12px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        .log-card pre {
            color: #10b981;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin: 0;
            white-space: pre-wrap;
        }
        
        /* Hidden */
        .hidden { display: none !important; }
        
        /* Result highlights */
        .result-value.highlight {
            color: #059669;
            font-size: 16px;
            font-weight: 700;
        }
        
        /* My Number specific styling */
        .result-item:has(.result-value.highlight) {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
        }
        
        /* Tabs responsive */
        .tabs {
            flex-wrap: wrap;
        }
        .tab {
            min-width: 70px;
            font-size: 12px;
        }
        .tab .icon {
            font-size: 20px;
        }
        
        /* Zairyu card image styles */
        .zairyu-image-container {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 12px;
        }
        .zairyu-image-container img {
            max-width: 100%;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .zairyu-photo {
            max-width: 120px !important;
        }
        
        /* Result item vertical layout */
        .result-item.vertical {
            flex-direction: column;
            align-items: flex-start;
        }
        .result-item.vertical .result-label {
            margin-bottom: 8px;
        }
        .result-item.vertical .result-value {
            text-align: left;
            max-width: 100%;
            width: 100%;
        }
        
        /* Pre-formatted text in results */
        .result-pre {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            width: 100%;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ“¡ NFC Card Reader</h1>
            <p class="subtitle">Suica â€¢ ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ â€¢ åœ¨ç•™ã‚«ãƒ¼ãƒ‰ â€¢ CCCD â€¢ Generic</p>
            
            <!-- Status -->
            <div id="statusBar" class="status-bar disconnected">
                <div class="status-dot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            
            <!-- Card Type Selector -->
            <div class="tabs" id="tabsContainer">
                <div class="tab active" data-type="generic">
                    <span class="icon">ğŸ’³</span>
                    Generic
                </div>
                <div class="tab" data-type="suica">
                    <span class="icon">ğŸšƒ</span>
                    Suica
                </div>
                <div class="tab" data-type="mynumber">
                    <span class="icon">ğŸªª</span>
                    ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼
                </div>
                <div class="tab" data-type="zairyu">
                    <span class="icon">ğŸ›‚</span>
                    åœ¨ç•™ã‚«ãƒ¼ãƒ‰
                </div>
                <div class="tab" data-type="cccd">
                    <span class="icon">ğŸ‡»ğŸ‡³</span>
                    CCCD
                </div>
                <div class="tab" data-type="ocr_test">
                    <span class="icon">ğŸ”</span>
                    OCRãƒ†ã‚¹ãƒˆ
                </div>
            </div>
            
            <!-- Generic Form -->
            <div id="formGeneric" class="form-container">
                <p style="color: #6b7280; text-align: center; padding: 20px 0;">
                    No input required for generic cards.<br>
                    Just place your card on the reader.
                </p>
                <button id="scanGenericBtn" class="btn-primary">
                    ğŸ” Scan Card
                </button>
            </div>
            
            <!-- CCCD Form -->
            <div id="formCCCD" class="form-container hidden">
                <div class="form-group">
                    <label>Sá»‘ CCCD (Card Number)</label>
                    <input type="text" id="cccdNumber" placeholder="001234567890" maxlength="12">
                    <div class="input-hint">12 sá»‘ trÃªn máº·t trÆ°á»›c tháº»</div>
                </div>
                <div class="form-group">
                    <label>NgÃ y sinh (Date of Birth)</label>
                    <input type="text" id="cccdBirth" placeholder="YYMMDD (vd: 900115)">
                    <div class="input-hint">NÄƒm-ThÃ¡ng-NgÃ y: 900115 = 15/01/1990</div>
                </div>
                <div class="form-group">
                    <label>NgÃ y háº¿t háº¡n (Expiry Date)</label>
                    <input type="text" id="cccdExpiry" placeholder="YYMMDD (vd: 350115)">
                    <div class="input-hint">NÄƒm-ThÃ¡ng-NgÃ y: 350115 = 15/01/2035</div>
                </div>
                <button id="scanCCCDBtn" class="btn-primary">
                    ğŸ” QuÃ©t tháº» CCCD
                </button>
            </div>
            
            <!-- My Number Form -->
            <div id="formMyNumber" class="form-container hidden">
                <div class="form-group">
                    <label>åˆ¸é¢å…¥åŠ›è£œåŠ©ç”¨PIN (4æ¡)</label>
                    <input type="password" id="mynumberPin" placeholder="****" maxlength="4">
                    <div class="input-hint">å¸‚å½¹æ‰€ã§è¨­å®šã—ãŸ4æ¡ã®æš—è¨¼ç•ªå·</div>
                </div>
                <div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; color: #065f46;">
                    <strong>ğŸ“‹ PINã‚’å…¥åŠ›ã™ã‚‹ã¨èª­ã¿å–ã‚Œã‚‹æƒ…å ±:</strong><br>
                    â€¢ å€‹äººç•ªå· (ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼12æ¡)<br>
                    â€¢ æ°åãƒ»ä½æ‰€ãƒ»ç”Ÿå¹´æœˆæ—¥ãƒ»æ€§åˆ¥
                </div>
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #92400e;">
                    âš ï¸ PINã‚’3å›é–“é•ãˆã‚‹ã¨ã‚«ãƒ¼ãƒ‰ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ï¼ˆå¸‚å½¹æ‰€ã§è§£é™¤ï¼‰
                </div>
                <button id="scanMyNumberBtn" class="btn-primary">
                    ğŸ” å€‹äººæƒ…å ±ã‚’èª­ã¿å–ã‚‹
                </button>
                <button id="scanMyNumberNoPinBtn" class="btn-secondary">
                    PINç„¡ã—ã§è¨¼æ˜æ›¸æƒ…å ±ã®ã¿ç¢ºèª
                </button>
            </div>
            
            <!-- Suica Form -->
            <div id="formSuica" class="form-container hidden">
                <div style="text-align: center; padding: 15px 0;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸšƒ</div>
                    <p style="color: #059669; font-weight: 600; margin-bottom: 5px;">
                        Suica / Pasmo / ICOCA
                    </p>
                    <p style="color: #6b7280; font-size: 14px;">
                        äº¤é€šç³»ICã‚«ãƒ¼ãƒ‰ã®IDã¨æƒ…å ±ã‚’èª­ã¿å–ã‚Šã¾ã™<br>
                        Read transit IC card info
                    </p>
                </div>
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #92400e;">
                    âš ï¸ <strong>æ®‹é«˜èª­å–ã«ã¤ã„ã¦:</strong><br>
                    æ®‹é«˜ãƒ»å±¥æ­´ã®èª­å–ã«ã¯ <a href="https://zadig.akeo.ie/" target="_blank" style="color:#1d4ed8">Zadig</a> ã§WinUSBãƒ‰ãƒ©ã‚¤ãƒã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚<br>
                    <small>IDmã®èª­å–ã¯ç¾åœ¨ã®è¨­å®šã§å¯èƒ½ã§ã™ã€‚</small>
                </div>
                <button id="scanSuicaBtn" class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ğŸ” ã‚«ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
                </button>
            </div>
            
            <!-- Zairyu Form -->
            <div id="formZairyu" class="form-container hidden">
                <div style="text-align: center; padding: 10px 0;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ›‚</div>
                    <p style="color: #7c3aed; font-weight: 600; margin-bottom: 5px;">
                        åœ¨ç•™ã‚«ãƒ¼ãƒ‰ / Residence Card
                    </p>
                </div>
                <div class="form-group">
                    <label>åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå· (Card Number)</label>
                    <input type="text" id="zairyuNumber" placeholder="AB12345678CD" maxlength="12">
                    <div class="input-hint">ã‚«ãƒ¼ãƒ‰è¡¨é¢ã®12æ¡ã®ç•ªå· (ä¾‹: AB12345678CD)</div>
                </div>
                <div style="background: #ede9fe; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; color: #5b21b6;">
                    <strong>ğŸ“‹ èª­ã¿å–ã‚Œã‚‹æƒ…å ±:</strong><br>
                    â€¢ åˆ¸é¢ã‚¤ãƒ¡ãƒ¼ã‚¸ (è¡¨é¢ã®ç”»åƒ)<br>
                    â€¢ é¡”å†™çœŸ<br>
                    â€¢ æ°åãƒ»å›½ç±ãƒ»åœ¨ç•™è³‡æ ¼ãƒ»ä½æ‰€ãªã©
                </div>
                <div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #065f46;">
                    âœ… <strong>ç”Ÿå¹´æœˆæ—¥ãƒ»æœ‰åŠ¹æœŸé™ã¯ä¸è¦</strong><br>
                    åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã¯ã‚«ãƒ¼ãƒ‰ç•ªå·ã®ã¿ã§èªè¨¼ã§ãã¾ã™
                </div>
                <button id="scanZairyuBtn" class="btn-primary" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    ğŸ” ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’èª­ã¿å–ã‚‹
                </button>
                <button id="scanZairyuBasicBtn" class="btn-secondary">
                    èªè¨¼ãªã—ã§åŸºæœ¬æƒ…å ±ã®ã¿
                </button>
            </div>
            
            <!-- OCR Test Form -->
            <div id="formOcrTest" class="form-container hidden">
                <div style="text-align: center; padding: 10px 0;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ”</div>
                    <p style="color: #059669; font-weight: 600; margin-bottom: 5px;">
                        OCRãƒ†ã‚¹ãƒˆ / OCR Test
                    </p>
                    <p style="color: #6b7280; font-size: 12px;">
                        ã‚«ãƒ¼ãƒ‰ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦OCRæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
                    </p>
                </div>
                <div class="form-group">
                    <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« / Image File</label>
                    <input type="file" id="ocrImageInput" accept="image/*" style="padding: 10px; border: 2px dashed #d1d5db; border-radius: 8px; width: 100%; box-sizing: border-box;">
                    <div class="input-hint">JPEG, PNG, TIFF, JP2 ãªã©å¯¾å¿œ</div>
                </div>
                
                <!-- Image preview -->
                <div id="ocrImagePreview" style="display: none; text-align: center; margin-bottom: 15px;">
                    <img id="ocrPreviewImg" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 2px solid #10b981;">
                </div>
                
                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #065f46;">
                    <strong>ğŸ“‹ æŠ½å‡ºã•ã‚Œã‚‹æƒ…å ±:</strong><br>
                    â€¢ æ°å (Name)<br>
                    â€¢ å›½ç± (Nationality)<br>
                    â€¢ åœ¨ç•™è³‡æ ¼ (Status of Residence)<br>
                    â€¢ ç”Ÿå¹´æœˆæ—¥ (Date of Birth)<br>
                    â€¢ åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå· (Card Number)<br>
                    â€¢ ãã®ä»–ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
                </div>
                
                <button id="runOcrBtn" class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);" disabled>
                    ğŸ” OCRã‚’å®Ÿè¡Œ / Run OCR
                </button>
                
                <!-- OCR Results -->
                <div id="ocrTestResults" style="display: none; margin-top: 15px;">
                </div>
            </div>
            
            <!-- Scan Animation -->
            <div id="scanArea" class="scan-area">
                <div class="nfc-icon">ğŸ“¡</div>
                <p style="margin-top: 20px; color: #6b7280;">
                    Äáº·t tháº» lÃªn Ä‘áº§u Ä‘á»c...<br>
                    Place card on reader...
                </p>
                <button id="cancelBtn" class="btn-danger">Cancel</button>
            </div>
            
            <!-- Error -->
            <div id="errorMsg" class="error-msg"></div>
            
            <!-- Results -->
            <div id="resultArea" class="result-area">
                <div class="result-header">
                    <span style="font-size: 24px;">âœ…</span>
                    <h3>Card Read Successfully!</h3>
                </div>
                <div id="resultContent"></div>
                <button id="newScanBtn" class="btn-secondary">
                    Scan Another Card
                </button>
            </div>
        </div>
        
        <!-- Log -->
        <div class="log-card">
            <pre id="logOutput">[Console Log]</pre>
        </div>
    </div>

    <script>
        const WS_URL = 'ws://localhost:3005';
        let ws = null;
        let currentCardType = 'generic';

        const el = {
            statusBar: document.getElementById('statusBar'),
            statusText: document.getElementById('statusText'),
            tabsContainer: document.getElementById('tabsContainer'),
            formGeneric: document.getElementById('formGeneric'),
            formCCCD: document.getElementById('formCCCD'),
            formMyNumber: document.getElementById('formMyNumber'),
            formSuica: document.getElementById('formSuica'),
            formZairyu: document.getElementById('formZairyu'),
            formOcrTest: document.getElementById('formOcrTest'),
            scanGenericBtn: document.getElementById('scanGenericBtn'),
            scanCCCDBtn: document.getElementById('scanCCCDBtn'),
            scanMyNumberBtn: document.getElementById('scanMyNumberBtn'),
            scanMyNumberNoPinBtn: document.getElementById('scanMyNumberNoPinBtn'),
            scanSuicaBtn: document.getElementById('scanSuicaBtn'),
            scanZairyuBtn: document.getElementById('scanZairyuBtn'),
            scanZairyuBasicBtn: document.getElementById('scanZairyuBasicBtn'),
            cccdNumber: document.getElementById('cccdNumber'),
            cccdBirth: document.getElementById('cccdBirth'),
            cccdExpiry: document.getElementById('cccdExpiry'),
            mynumberPin: document.getElementById('mynumberPin'),
            zairyuNumber: document.getElementById('zairyuNumber'),
            ocrImageInput: document.getElementById('ocrImageInput'),
            ocrImagePreview: document.getElementById('ocrImagePreview'),
            ocrPreviewImg: document.getElementById('ocrPreviewImg'),
            runOcrBtn: document.getElementById('runOcrBtn'),
            ocrTestResults: document.getElementById('ocrTestResults'),
            scanArea: document.getElementById('scanArea'),
            cancelBtn: document.getElementById('cancelBtn'),
            errorMsg: document.getElementById('errorMsg'),
            resultArea: document.getElementById('resultArea'),
            resultContent: document.getElementById('resultContent'),
            newScanBtn: document.getElementById('newScanBtn'),
            logOutput: document.getElementById('logOutput')
        };

        // Utility functions
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            el.logOutput.textContent += `\n[${time}] ${msg}`;
            el.logOutput.parentElement.scrollTop = el.logOutput.parentElement.scrollHeight;
        }

        function setStatus(status, text) {
            el.statusBar.className = `status-bar ${status}`;
            el.statusText.textContent = text;
        }

        function showError(msg) {
            el.errorMsg.textContent = msg;
            el.errorMsg.classList.add('show');
        }

        function hideError() {
            el.errorMsg.classList.remove('show');
        }

        function showForm(type) {
            el.formGeneric.classList.add('hidden');
            el.formCCCD.classList.add('hidden');
            el.formMyNumber.classList.add('hidden');
            el.formSuica.classList.add('hidden');
            el.formZairyu.classList.add('hidden');
            el.formOcrTest.classList.add('hidden');
            el.scanArea.classList.remove('active');
            el.resultArea.classList.remove('show');
            hideError();

            if (type === 'generic') el.formGeneric.classList.remove('hidden');
            if (type === 'cccd') el.formCCCD.classList.remove('hidden');
            if (type === 'mynumber') el.formMyNumber.classList.remove('hidden');
            if (type === 'suica') el.formSuica.classList.remove('hidden');
            if (type === 'zairyu') el.formZairyu.classList.remove('hidden');
            if (type === 'ocr_test') el.formOcrTest.classList.remove('hidden');
        }

        function showScanAnimation() {
            el.formGeneric.classList.add('hidden');
            el.formCCCD.classList.add('hidden');
            el.formMyNumber.classList.add('hidden');
            el.formOcrTest.classList.add('hidden');
            el.formSuica.classList.add('hidden');
            el.formZairyu.classList.add('hidden');
            el.scanArea.classList.add('active');
        }

        function hideScanAnimation() {
            el.scanArea.classList.remove('active');
            showForm(currentCardType);
        }

        function showResults(data) {
            el.scanArea.classList.remove('active');
            el.formGeneric.classList.add('hidden');
            el.formCCCD.classList.add('hidden');
            el.formMyNumber.classList.add('hidden');
            el.formSuica.classList.add('hidden');
            el.formZairyu.classList.add('hidden');
            
            // Define display labels for My Number card fields
            const fieldLabels = {
                'card_type': 'ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥',
                'my_number': 'å€‹äººç•ªå·',
                'name': 'æ°å',
                'address': 'ä½æ‰€',
                'birthdate': 'ç”Ÿå¹´æœˆæ—¥',
                'gender': 'æ€§åˆ¥',
                'balance': 'æ®‹é«˜',
                'uid': 'UID',
                'pin_verified': 'PINèªè¨¼',
                'personal_info_read': 'å€‹äººæƒ…å ±èª­å–',
                'timestamp': 'èª­å–æ—¥æ™‚',
                'reader': 'ã‚«ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼'
            };
            
            // Priority order for display (important fields first)
            const priorityFields = ['card_type', 'my_number', 'name', 'address', 'birthdate', 'gender', 'balance'];
            
            let html = '';
            
            // First, show priority fields
            for (const key of priorityFields) {
                if (data[key] !== undefined) {
                    html += renderResultItem(key, data[key], fieldLabels);
                }
            }
            
            // Then show remaining fields
            for (const [key, value] of Object.entries(data)) {
                if (priorityFields.includes(key)) continue;
                // Skip some internal/noisy fields
                if (['atr', 'auth_cert_preview', 'simulated'].includes(key)) continue;
                
                html += renderResultItem(key, value, fieldLabels);
            }
            
            el.resultContent.innerHTML = html;
            el.resultArea.classList.add('show');
        }
        
        function renderResultItem(key, value, labels) {
            let displayValue;
            let displayLabel = labels[key] || key;
            
            if (Array.isArray(value)) {
                // Special handling for Suica history
                displayValue = value.map((item, idx) => {
                    if (typeof item === 'object') {
                        return `<div style="background:#f3f4f6;padding:8px;border-radius:6px;margin:4px 0;font-size:12px;">
                            ${Object.entries(item).map(([k,v]) => `<span style="color:#6b7280">${k}:</span> ${v}`).join(' | ')}
                        </div>`;
                    }
                    return item;
                }).join('');
            } else if (typeof value === 'object') {
                displayValue = JSON.stringify(value, null, 2);
            } else if (typeof value === 'boolean') {
                displayValue = value ? 'âœ…' : 'âŒ';
            } else {
                displayValue = value;
            }
            
            // Highlight important fields
            let valueClass = 'result-value';
            if (['balance', 'card_type', 'my_number', 'name'].includes(key)) {
                valueClass += ' highlight';
            }
            
            // Special styling for my_number (mask middle digits)
            if (key === 'my_number' && typeof displayValue === 'string' && displayValue.length === 12) {
                displayValue = `${displayValue.slice(0,4)} **** ${displayValue.slice(-4)}`;
            }
            
            return `
                <div class="result-item">
                    <span class="result-label">${displayLabel}</span>
                    <span class="${valueClass}">${displayValue}</span>
                </div>
            `;
        }
        
        function showZairyuResults(data) {
            el.scanArea.classList.remove('active');
            el.formGeneric.classList.add('hidden');
            el.formCCCD.classList.add('hidden');
            el.formMyNumber.classList.add('hidden');
            el.formSuica.classList.add('hidden');
            el.formZairyu.classList.add('hidden');
            
            let html = '';
            
            // Header with card type
            html += `
                <div style="text-align: center; margin-bottom: 15px;">
                    <span style="font-size: 48px;">ğŸ›‚</span>
                    <h3 style="color: #7c3aed; margin: 10px 0;">åœ¨ç•™ã‚«ãƒ¼ãƒ‰ / Residence Card</h3>
                </div>
            `;
            
            // Show images if available (THIS IS WHERE PERSONAL INFO IS!)
            if (data.photo_base64) {
                html += `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <p style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">é¡”å†™çœŸ / Photo</p>
                        <img src="data:image/jpeg;base64,${data.photo_base64}" 
                             alt="Face Photo" 
                             style="max-width: 150px; border-radius: 8px; border: 2px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    </div>
                `;
            }
            
            if (data.front_image_base64) {
                html += `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <p style="font-size: 14px; color: #059669; margin-bottom: 8px; font-weight: 600;">
                            ğŸ“‹ åˆ¸é¢ã‚¤ãƒ¡ãƒ¼ã‚¸ / Card Front<br>
                            <span style="font-size: 11px; font-weight: normal; color: #6b7280;">
                                ï¼ˆæ°åãƒ»å›½ç±ãƒ»åœ¨ç•™è³‡æ ¼ãªã©ã¯ã“ã®ç”»åƒå†…ã«å«ã¾ã‚Œã¦ã„ã¾ã™ï¼‰
                            </span>
                        </p>
                        <img src="data:image/jpeg;base64,${data.front_image_base64}" 
                             alt="Card Front" 
                             style="max-width: 100%; border-radius: 8px; border: 3px solid #10b981; box-shadow: 0 4px 12px rgba(16,185,129,0.3);">
                    </div>
                `;
            }
            
            // Show card type
            if (data.card_type) {
                html += `
                    <div class="result-item" style="background: #ede9fe; border: 1px solid #c4b5fd;">
                        <span class="result-label">ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥</span>
                        <span class="result-value highlight" style="color: #7c3aed;">${data.card_type}</span>
                    </div>
                `;
                if (data.card_type_en) {
                    html += `
                        <div class="result-item">
                            <span class="result-label">Card Type</span>
                            <span class="result-value">${data.card_type_en}</span>
                        </div>
                    `;
                }
            }
            
            // Show authentication status
            if (data.authenticated !== undefined) {
                html += `
                    <div class="result-item" style="background: ${data.authenticated ? '#d1fae5' : '#fee2e2'};">
                        <span class="result-label">èªè¨¼çŠ¶æ…‹</span>
                        <span class="result-value">${data.authenticated ? 'âœ… èªè¨¼æˆåŠŸ' : 'âŒ æœªèªè¨¼'}</span>
                    </div>
                `;
            }
            
            // Show UID
            if (data.uid) {
                html += `
                    <div class="result-item">
                        <span class="result-label">UID</span>
                        <span class="result-value" style="font-family: monospace;">${data.uid}</span>
                    </div>
                `;
            }
            
            // ============================================
            // DF2 Data: Address and Endorsements
            // (Per åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç­‰ä»•æ§˜æ›¸ Ver 1.5 Section 3.3.4)
            // ============================================
            
            // Section header for DF2 data
            html += `
                <div style="margin-top: 20px; padding: 10px 0; border-top: 2px solid #e5e7eb;">
                    <h4 style="color: #374151; font-size: 14px; margin: 0 0 10px 0;">ğŸ“ è£é¢ãƒ‡ãƒ¼ã‚¿ / Back of Card Data</h4>
                </div>
            `;
            
            // Address section (DF2/EF01)
            if (data.address || data.address_write_date || data.city_code) {
                html += `<div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-bottom: 10px;">`;
                html += `<div style="font-weight: 600; color: #166534; margin-bottom: 8px;">ğŸ  ä½å±…åœ° / Address</div>`;
                
                if (data.address) {
                    html += `
                        <div class="result-item" style="background: white;">
                            <span class="result-label">ä½æ‰€</span>
                            <span class="result-value" style="text-align: left;">${data.address}</span>
                        </div>
                    `;
                }
                if (data.city_code) {
                    html += `
                        <div class="result-item" style="background: white;">
                            <span class="result-label">å¸‚ç”ºæ‘ã‚³ãƒ¼ãƒ‰</span>
                            <span class="result-value">${data.city_code}</span>
                        </div>
                    `;
                }
                if (data.address_write_date) {
                    html += `
                        <div class="result-item" style="background: white;">
                            <span class="result-label">è¿½è¨˜æ—¥</span>
                            <span class="result-value">${data.address_write_date}</span>
                        </div>
                    `;
                }
                html += `</div>`;
            }
            
            // Work Permission / Endorsements section (DF2/EF02-04)
            const hasEndorsements = data.work_permission_general || data.work_permission_specific || data.status_update_application;
            if (hasEndorsements) {
                html += `<div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 10px;">`;
                html += `<div style="font-weight: 600; color: #92400e; margin-bottom: 8px;">ğŸ“‹ è£é¢è¿½è¨˜æ¬„ / Endorsements</div>`;
                
                if (data.work_permission_general) {
                    html += `
                        <div class="result-item" style="background: white; flex-direction: column; align-items: flex-start;">
                            <span class="result-label" style="margin-bottom: 4px;">è³‡æ ¼å¤–æ´»å‹•åŒ…æ‹¬è¨±å¯</span>
                            <span class="result-value" style="text-align: left;">${data.work_permission_general}</span>
                        </div>
                    `;
                }
                if (data.work_permission_specific) {
                    html += `
                        <div class="result-item" style="background: white; flex-direction: column; align-items: flex-start;">
                            <span class="result-label" style="margin-bottom: 4px;">è³‡æ ¼å¤–æ´»å‹•å€‹åˆ¥è¨±å¯</span>
                            <span class="result-value" style="text-align: left;">${data.work_permission_specific}</span>
                        </div>
                    `;
                }
                if (data.status_update_application) {
                    html += `
                        <div class="result-item" style="background: white; flex-direction: column; align-items: flex-start;">
                            <span class="result-label" style="margin-bottom: 4px;">åœ¨ç•™æœŸé–“ç­‰æ›´æ–°ç”³è«‹</span>
                            <span class="result-value" style="text-align: left;">${data.status_update_application}</span>
                        </div>
                    `;
                }
                html += `</div>`;
            }
            
            // Certificate info
            if (data.certificate_available || data.signature_size) {
                html += `
                    <div class="result-item">
                        <span class="result-label">é›»å­ç½²å (DF3)</span>
                        <span class="result-value">âœ… ${data.certificate_size || data.signature_size || ''} bytes</span>
                    </div>
                `;
            }
            
            // Timestamp
            if (data.timestamp) {
                html += `
                    <div class="result-item">
                        <span class="result-label">èª­å–æ—¥æ™‚</span>
                        <span class="result-value">${new Date(data.timestamp).toLocaleString('ja-JP')}</span>
                    </div>
                `;
            }
            
            // ============================================
            // OCR Results - Personal info extracted from card image
            // ============================================
            const ocrFields = [
                { key: 'ocr_name', label: 'æ°å / Name', highlight: true },
                { key: 'ocr_card_number', label: 'åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå· / Card Number' },
                { key: 'ocr_nationality', label: 'å›½ç±ãƒ»åœ°åŸŸ / Nationality' },
                { key: 'ocr_date_of_birth', label: 'ç”Ÿå¹´æœˆæ—¥ / Date of Birth' },
                { key: 'ocr_gender', label: 'æ€§åˆ¥ / Gender' },
                { key: 'ocr_status_of_residence', label: 'åœ¨ç•™è³‡æ ¼ / Status of Residence' },
                { key: 'ocr_period_of_stay', label: 'åœ¨ç•™æœŸé–“ / Period of Stay' },
                { key: 'ocr_expiration_date', label: 'åœ¨ç•™æœŸé–“ã®æº€äº†æ—¥ / Expiration' },
                { key: 'ocr_work_permission', label: 'å°±åŠ´åˆ¶é™ / Work Permission' },
                { key: 'ocr_address', label: 'ä½å±…åœ° / Address' },
            ];
            
            let hasOcrData = ocrFields.some(f => data[f.key]);
            
            if (hasOcrData) {
                html += `
                    <div style="margin-top: 20px; padding: 10px 0; border-top: 2px solid #e5e7eb;">
                        <h4 style="color: #059669; font-size: 14px; margin: 0 0 10px 0;">
                            ğŸ” OCRæŠ½å‡ºãƒ‡ãƒ¼ã‚¿ / OCR Extracted Data
                            <span style="font-size: 11px; font-weight: normal; color: #6b7280;">(ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š)</span>
                        </h4>
                    </div>
                `;
                
                html += `<div style="background: #ecfdf5; padding: 12px; border-radius: 8px; border: 1px solid #a7f3d0;">`;
                
                for (const field of ocrFields) {
                    if (data[field.key]) {
                        const bgStyle = field.highlight ? 'background: white; border: 2px solid #10b981;' : 'background: white;';
                        const valueStyle = field.highlight ? 'color: #059669; font-size: 15px; font-weight: 700;' : '';
                        html += `
                            <div class="result-item" style="${bgStyle}">
                                <span class="result-label">${field.label}</span>
                                <span class="result-value" style="${valueStyle}">${data[field.key]}</span>
                            </div>
                        `;
                    }
                }
                
                html += `</div>`;
            } else if (data.ocr_note) {
                // OCR not available
                html += `
                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 12px; color: #92400e; border: 1px solid #fcd34d;">
                        <strong>ğŸ’¡ OCRæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:</strong><br>
                        å€‹äººæƒ…å ±ã‚’ç”»åƒã‹ã‚‰æŠ½å‡ºã™ã‚‹ã«ã¯ã€EasyOCRã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼š<br>
                        <code style="background: #fffbeb; padding: 2px 6px; border-radius: 3px;">pip install easyocr</code>
                    </div>
                `;
            }
            
            // OCR raw text (collapsible debug section)
            if (data.ocr_result && data.ocr_result.raw_text && data.ocr_result.raw_text.length > 0) {
                html += `
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #059669; font-size: 12px;">ğŸ“ OCRå…¨ãƒ†ã‚­ã‚¹ãƒˆ (${data.ocr_result.raw_text.length} regions)</summary>
                        <div style="margin-top: 8px; font-size: 11px; background: #f0fdf4; padding: 10px; border-radius: 6px;">
                            ${data.ocr_result.raw_text.map(r => 
                                `<div style="margin-bottom: 4px; padding: 4px; background: white; border-radius: 4px;">
                                    <span style="color: #059669; font-weight: 600;">"${r.text}"</span>
                                    <span style="color: #9ca3af; font-size: 10px; margin-left: 8px;">conf: ${(r.confidence * 100).toFixed(0)}%</span>
                                </div>`
                            ).join('')}
                        </div>
                    </details>
                `;
            }
            
            // Debug: Show raw data
            if (data.address_raw || data.endorsement_1_raw || data.endorsement_2_raw || data.endorsement_3_raw) {
                html += `
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; color: #6b7280; font-size: 12px;">ğŸ”§ Debug: Raw Data</summary>
                        <div style="margin-top: 8px; font-size: 11px; font-family: monospace; background: #f9fafb; padding: 10px; border-radius: 6px; word-break: break-all;">
                            ${data.address_raw ? `<div><strong>Address (DF2/EF01):</strong> ${data.address_raw}</div>` : ''}
                            ${data.endorsement_1_raw ? `<div><strong>Endorsement 1 (DF2/EF02):</strong> ${data.endorsement_1_raw}</div>` : ''}
                            ${data.endorsement_2_raw ? `<div><strong>Endorsement 2 (DF2/EF03):</strong> ${data.endorsement_2_raw}</div>` : ''}
                            ${data.endorsement_3_raw ? `<div><strong>Endorsement 3 (DF2/EF04):</strong> ${data.endorsement_3_raw}</div>` : ''}
                        </div>
                    </details>
                `;
            }
            
            el.resultContent.innerHTML = html;
            el.resultArea.classList.add('show');
        }

        // WebSocket connection
        function connect() {
            log('Connecting to ' + WS_URL);
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                log('Connected!');
                setStatus('connected', 'Connected to NFC Bridge');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log('Received: ' + data.type);
                handleMessage(data);
            };

            ws.onclose = () => {
                log('Disconnected');
                setStatus('disconnected', 'Disconnected - Reconnecting...');
                setTimeout(connect, 3000);
            };

            ws.onerror = () => {
                log('WebSocket error');
                showError('Cannot connect to NFC Bridge. Is server.py running?');
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'connected':
                    const readerInfo = data.reader_available 
                        ? `Reader: ${data.reader_name || 'Connected'}` 
                        : 'No reader detected';
                    setStatus('connected', readerInfo);
                    log('Reader: ' + (data.reader_name || 'None'));
                    break;

                case 'status':
                    if (data.status === 'waiting_for_card') {
                        setStatus('waiting', data.message || 'Waiting for card...');
                        showScanAnimation();
                    } else if (data.status === 'reading') {
                        setStatus('reading', data.message || 'Reading card...');
                    } else if (data.status === 'cancelled') {
                        setStatus('connected', 'Ready');
                        hideScanAnimation();
                    }
                    break;

                case 'scan_result':
                    if (data.success) {
                        log('Card data: ' + JSON.stringify(data.data));
                        showResults(data.data);
                        setStatus('connected', 'Scan complete!');
                    } else {
                        hideScanAnimation();
                        showError(data.error || 'Scan failed');
                        setStatus('connected', 'Ready');
                    }
                    break;
                
                case 'mynumber_result':
                    // Handle dedicated My Number API response
                    if (data.success) {
                        log('My Number data received');
                        // Build display data
                        const displayData = {
                            card_type: 'ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰',
                            my_number: data.my_number,
                            name: data.name,
                            address: data.address,
                            birthdate: data.birthdate,
                            gender: data.gender
                        };
                        showResults(displayData);
                        setStatus('connected', 'èª­ã¿å–ã‚Šå®Œäº†ï¼');
                    } else {
                        hideScanAnimation();
                        // Show error with instruction
                        const errorMsg = data.error_ja || data.error_en || data.error;
                        const instruction = data.instruction_ja || data.instruction_en || '';
                        
                        let fullError = errorMsg;
                        if (instruction) {
                            fullError += '\n\nğŸ’¡ ' + instruction;
                        }
                        if (data.remaining_tries !== undefined && data.remaining_tries >= 0) {
                            fullError += `\n\nâš ï¸ æ®‹ã‚Šè©¦è¡Œå›æ•°: ${data.remaining_tries}å›`;
                        }
                        
                        showError(fullError);
                        setStatus('connected', 'ã‚¨ãƒ©ãƒ¼');
                        log('My Number error: ' + data.error);
                    }
                    break;
                
                case 'zairyu_result':
                    // Handle dedicated Zairyu Card API response
                    if (data.success) {
                        log('Zairyu card data received');
                        showZairyuResults(data);
                        setStatus('connected', 'èª­ã¿å–ã‚Šå®Œäº†ï¼');
                    } else {
                        hideScanAnimation();
                        // Show error with instruction
                        const zairyuErrorMsg = data.error_ja || data.error_en || data.error;
                        const zairyuInstruction = data.instruction_ja || data.instruction_en || '';
                        
                        let zairyuFullError = zairyuErrorMsg;
                        if (zairyuInstruction) {
                            zairyuFullError += '\n\nğŸ’¡ ' + zairyuInstruction;
                        }
                        
                        showError(zairyuFullError);
                        setStatus('connected', 'ã‚¨ãƒ©ãƒ¼');
                        log('Zairyu error: ' + data.error);
                    }
                    break;
                
                case 'ocr_result':
                    // Handle OCR test result
                    log('OCR result received');
                    showOcrTestResults(data);
                    setStatus('connected', 'OCRå®Œäº†');
                    break;

                case 'error':
                    showError(data.error);
                    hideScanAnimation();
                    setStatus('connected', 'Ready');
                    break;
            }
        }

        function startScan(cardType, params = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('Not connected to bridge');
                return;
            }
            
            hideError();
            log(`Starting ${cardType} scan...`);
            
            ws.send(JSON.stringify({
                type: 'start_scan',
                card_type: cardType,
                timeout: 30,
                ...params
            }));
        }

        // Event Listeners
        
        // Tab switching
        el.tabsContainer.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (!tab) return;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            currentCardType = tab.dataset.type;
            showForm(currentCardType);
        });

        // Generic scan
        el.scanGenericBtn.addEventListener('click', () => {
            startScan('generic');
        });

        // CCCD scan
        el.scanCCCDBtn.addEventListener('click', () => {
            const cardNumber = el.cccdNumber.value.trim();
            const birthDate = el.cccdBirth.value.trim();
            const expiryDate = el.cccdExpiry.value.trim();

            if (cardNumber.length !== 12) {
                showError('Sá»‘ CCCD pháº£i cÃ³ 12 sá»‘');
                return;
            }
            if (birthDate.length !== 6) {
                showError('NgÃ y sinh pháº£i cÃ³ dáº¡ng YYMMDD (6 sá»‘)');
                return;
            }
            if (expiryDate.length !== 6) {
                showError('NgÃ y háº¿t háº¡n pháº£i cÃ³ dáº¡ng YYMMDD (6 sá»‘)');
                return;
            }

            startScan('cccd', {
                card_number: cardNumber,
                birth_date: birthDate,
                expiry_date: expiryDate
            });
        });

        // My Number scan with PIN - use dedicated API
        el.scanMyNumberBtn.addEventListener('click', () => {
            const pin = el.mynumberPin.value.trim();

            if (!pin) {
                showError('PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showError('PINã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            readMyNumberCard(pin);
        });

        // My Number scan without PIN
        el.scanMyNumberNoPinBtn.addEventListener('click', () => {
            startScan('mynumber', { pin: '' });
        });
        
        // Dedicated My Number API call
        function readMyNumberCard(pin) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            hideError();
            setStatus('reading', 'ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šä¸­...');
            log('Reading My Number card with PIN...');
            
            ws.send(JSON.stringify({
                type: 'read_mynumber',
                pin: pin
            }));
        }

        // Suica scan
        el.scanSuicaBtn.addEventListener('click', () => {
            startScan('suica');
        });

        // Zairyu scan with auth - uses dedicated read_zairyu API (card number only!)
        el.scanZairyuBtn.addEventListener('click', () => {
            const cardNumber = el.zairyuNumber.value.trim().toUpperCase();

            if (!cardNumber) {
                showError('åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nPlease enter your card number');
                return;
            }
            if (cardNumber.length !== 12) {
                showError('åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå·ã¯12æ¡ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™\nCard number must be 12 characters');
                return;
            }

            readZairyuCard(cardNumber);
        });

        // Zairyu scan without auth
        el.scanZairyuBasicBtn.addEventListener('click', () => {
            startScan('zairyu', {});
        });
        
        // ============================================
        // OCR Test - Upload image and run OCR
        // ============================================
        
        // Handle image file selection
        el.ocrImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                el.ocrImagePreview.style.display = 'none';
                el.runOcrBtn.disabled = true;
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                el.ocrPreviewImg.src = e.target.result;
                el.ocrImagePreview.style.display = 'block';
                el.runOcrBtn.disabled = false;
                el.ocrTestResults.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            log('Image selected: ' + file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)');
        });
        
        // Run OCR on selected image
        el.runOcrBtn.addEventListener('click', () => {
            const file = el.ocrImageInput.files[0];
            if (!file) {
                showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // Convert file to base64
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Data = e.target.result.split(',')[1]; // Remove data:image/xxx;base64, prefix
                
                el.runOcrBtn.disabled = true;
                el.runOcrBtn.textContent = 'ğŸ”„ OCRå®Ÿè¡Œä¸­...';
                hideError();
                log('Running OCR on uploaded image...');
                
                ws.send(JSON.stringify({
                    type: 'test_ocr',
                    image_base64: base64Data,
                    filename: file.name
                }));
            };
            reader.readAsDataURL(file);
        });
        
        // Display OCR test results
        function showOcrTestResults(data) {
            el.runOcrBtn.disabled = false;
            el.runOcrBtn.textContent = 'ğŸ” OCRã‚’å®Ÿè¡Œ / Run OCR';
            
            let html = '';
            
            if (data.error) {
                html = `
                    <div style="background: #fee2e2; padding: 12px; border-radius: 8px; color: #991b1b;">
                        <strong>âŒ ã‚¨ãƒ©ãƒ¼:</strong> ${data.error}
                    </div>
                `;
            } else if (data.ocr_result) {
                const ocr = data.ocr_result;
                
                // Show parsed fields
                if (ocr.parsed_fields && Object.keys(ocr.parsed_fields).length > 0) {
                    html += `
                        <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #a7f3d0;">
                            <div style="font-weight: 600; color: #059669; margin-bottom: 10px;">âœ… æŠ½å‡ºã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</div>
                    `;
                    
                    const fieldLabels = {
                        'name': 'æ°å / Name',
                        'card_number': 'ã‚«ãƒ¼ãƒ‰ç•ªå· / Card Number',
                        'nationality': 'å›½ç± / Nationality',
                        'date_of_birth': 'ç”Ÿå¹´æœˆæ—¥ / Date of Birth',
                        'gender': 'æ€§åˆ¥ / Gender',
                        'status_of_residence': 'åœ¨ç•™è³‡æ ¼ / Status',
                        'period_of_stay': 'åœ¨ç•™æœŸé–“ / Period',
                        'expiration_date': 'æº€äº†æ—¥ / Expiration',
                        'work_permission': 'å°±åŠ´åˆ¶é™ / Work',
                        'address': 'ä½æ‰€ / Address'
                    };
                    
                    for (const [key, value] of Object.entries(ocr.parsed_fields)) {
                        const label = fieldLabels[key] || key;
                        const isName = key === 'name';
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 6px 10px; background: white; border-radius: 4px; margin-bottom: 4px; ${isName ? 'border: 2px solid #10b981;' : ''}">
                                <span style="color: #6b7280; font-size: 12px;">${label}</span>
                                <span style="font-weight: ${isName ? '700' : '500'}; color: ${isName ? '#059669' : '#1f2937'}; font-size: ${isName ? '14px' : '13px'};">${value}</span>
                            </div>
                        `;
                    }
                    html += `</div>`;
                } else {
                    html += `
                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 10px; color: #92400e;">
                            âš ï¸ ãƒ‘ãƒ¼ã‚¹å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
                        </div>
                    `;
                }
                
                // Show raw OCR text
                if (ocr.raw_text && ocr.raw_text.length > 0) {
                    html += `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #059669; font-size: 12px; font-weight: 600;">
                                ğŸ“ OCRå…¨ãƒ†ã‚­ã‚¹ãƒˆ (${ocr.raw_text.length} regions)
                            </summary>
                            <div style="margin-top: 8px; font-size: 11px; background: #f0fdf4; padding: 10px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                                ${ocr.raw_text.map(r => 
                                    `<div style="margin-bottom: 4px; padding: 4px; background: white; border-radius: 4px;">
                                        <span style="color: #059669; font-weight: 600;">"${r.text}"</span>
                                        <span style="color: #9ca3af; font-size: 10px; margin-left: 8px;">conf: ${(r.confidence * 100).toFixed(0)}%</span>
                                    </div>`
                                ).join('')}
                            </div>
                        </details>
                    `;
                }
            }
            
            el.ocrTestResults.innerHTML = html;
            el.ocrTestResults.style.display = 'block';
            log('OCR test complete');
        }
        
        // Dedicated Zairyu Card API call (card number only - per åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç­‰ä»•æ§˜æ›¸ Ver 1.5)
        function readZairyuCard(cardNumber) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            hideError();
            setStatus('reading', 'åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šä¸­...');
            showScanAnimation();
            log('Reading Zairyu card with number: ' + cardNumber.slice(0,4) + '****' + cardNumber.slice(-2));
            
            ws.send(JSON.stringify({
                type: 'read_zairyu',
                card_number: cardNumber
            }));
        }

        // Cancel
        el.cancelBtn.addEventListener('click', () => {
            log('Cancelling scan');
            ws.send(JSON.stringify({ type: 'cancel_scan' }));
        });

        // New scan
        el.newScanBtn.addEventListener('click', () => {
            el.resultArea.classList.remove('show');
            showForm(currentCardType);
            hideError();
        });

        // Auto-format inputs
        el.cccdNumber.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 12);
        });
        el.cccdBirth.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
        });
        el.cccdExpiry.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
        });
        el.mynumberPin.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
        });
        el.zairyuNumber.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().slice(0, 12);
        });

        // Start connection
        connect();
    </script>
</body>
</html>
